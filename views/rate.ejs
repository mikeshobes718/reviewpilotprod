<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Your Experience • ReviewPilot</title>
    <meta name="csrf-token" content="<%= csrfToken %>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <%- include('partials/head') %>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; min-height:100vh; margin:0; background: var(--bg); color: var(--text); display:block; }
        .modal-card{ max-width: 480px; width: 92%; margin: 40px auto; text-align:center }
        .modal-title{ font-size: 28px; font-weight: 800; margin: 0 0 6px; color: var(--text); text-align:center }
        .modal-sub{ color: var(--muted); margin:0 0 16px; text-align:center }
        .hidden { display: none; }
        .stars { display:flex; justify-content:center; align-items:center; gap:10px; font-size:44px; color: #CBD5E0; cursor:pointer; transition: transform 0.2s ease }
        .star {
             transition: color 0.2s ease, transform 0.2s ease;
        }
        .star:hover {
            transform: scale(1.2);
        }
        .star.selected { color: var(--accent) }
        h2 { font-size: 20px; font-weight: 700 }
        p { color: var(--muted); line-height:1.6; margin-bottom: 16px }
        form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            text-align: left;
        }
        input, textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(16,185,129,.2);
        }
        .branding { margin: 16px auto 0; font-size: 0.875rem; color: var(--muted); text-align:center }
        .branding a { color: var(--accent); text-decoration:none; font-weight:600 }
    </style>
</head>
<body>
    <div class="base-card modal-card">
        <!-- Initial Rating Section -->
        <div id="rating-section">
            <div class="modal-title">How was your experience at<br><strong><%= business.businessName %></strong>?</div>
            <p class="modal-sub">Your feedback helps them improve.</p>
            <div class="stars">
                <span class="star" data-value="1">★</span>
                <span class="star" data-value="2">★</span>
                <span class="star" data-value="3">★</span>
                <span class="star" data-value="4">★</span>
                <span class="star" data-value="5">★</span>
            </div>
        </div>

        <!-- 1-3 Star Feedback Form -->
        <div id="contact-section" class="hidden">
            <h2 id="contact-title">Tell us a bit about you</h2>
            <p id="contact-subtitle">Please share your contact info. If your rating is 4 or below, also tell us how we can improve.</p>
            <form id="contact-form">
                <input type="text" id="name" placeholder="Your Name" required>
                <input type="email" id="email" placeholder="Your Email" required>
                <input type="tel" id="phone" placeholder="Your Phone (Optional)">
                <div id="feedback-wrapper" class="hidden">
                    <textarea id="feedback-text" placeholder="How could we have made it a 5-star experience?" rows="4"></textarea>
                </div>
                <button type="submit" class="btn-primary">Submit</button>
            </form>
        </div>

        <!-- Thank You Message -->
        <div id="thank-you-section" class="hidden">
            <h2>Thank you!</h2>
            <p>We appreciate you taking the time to help us improve.</p>
        </div>
    </div>
    
    <div class="branding">
        Powered by <a href="#" target="_blank">ReviewPilot</a>
    </div>

    <% if (hcaptchaSiteKey) { %>
    <div class="hidden">
        <div class="h-captcha" data-sitekey="<%= hcaptchaSiteKey %>"></div>
    </div>
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <% } %>

    <script>
        // The JavaScript logic remains the same as it's already perfect.
        document.addEventListener('DOMContentLoaded', () => {
            const ratingSection = document.getElementById('rating-section');
            const contactSection = document.getElementById('contact-section');
            const contactTitle = document.getElementById('contact-title');
            const contactSubtitle = document.getElementById('contact-subtitle');
            const contactForm = document.getElementById('contact-form');
            const feedbackWrapper = document.getElementById('feedback-wrapper');
            const feedbackTextarea = document.getElementById('feedback-text');
            const thankYouSection = document.getElementById('thank-you-section');
            const stars = document.querySelectorAll('.star');
            
            let userRating = 0;

            stars.forEach(star => {
                star.addEventListener('mouseover', e => {
                    const hoverValue = parseInt(e.target.dataset.value);
                    stars.forEach(s => s.style.color = parseInt(s.dataset.value) <= hoverValue ? 'var(--accent)' : '#CBD5E0');
                });

                star.addEventListener('mouseout', () => {
                    stars.forEach(s => {
                        if (!s.classList.contains('selected')) {
                            s.style.color = '#CBD5E0';
                        }
                    });
                });
                
                star.addEventListener('click', e => {
                    userRating = parseInt(e.target.dataset.value);
                    stars.forEach(s => {
                        s.classList.toggle('selected', parseInt(s.dataset.value) <= userRating);
                        if (s.classList.contains('selected')) { s.style.color = 'var(--accent)'; }
                    });
                    handleRating(userRating);
                });
            });

            function handleRating(rating) {
                setTimeout(() => {
                    ratingSection.classList.add('hidden');
                    // Always collect contact info. For 4 and under, also require feedback.
                    if (rating <= 4) {
                        contactTitle.textContent = 'Thanks for your rating';
                        contactSubtitle.textContent = 'Please share your contact info and tell us how we can improve.';
                        feedbackWrapper.classList.remove('hidden');
                        feedbackTextarea.setAttribute('required', 'required');
                    } else {
                        contactTitle.textContent = 'Almost there!';
                        contactSubtitle.textContent = 'Please share your contact info before leaving a public Google review.';
                        feedbackWrapper.classList.add('hidden');
                        feedbackTextarea.removeAttribute('required');
                        feedbackTextarea.value = '';
                    }
                    contactSection.classList.remove('hidden');
                }, 300);
            }

            contactForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const payload = {
                    rating: userRating,
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    feedback: feedbackWrapper.classList.contains('hidden') ? undefined : feedbackTextarea.value,
                    type: userRating === 5 ? 'positive' : 'feedback'
                };
                await submitData(`/submit-feedback/<%= business.uid %>`, payload, contactSection);
                if (userRating === 5) {
                    const googleReviewUrl = `https://search.google.com/local/writereview?placeid=<%= business.googlePlaceId %>`;
                    window.location.href = googleReviewUrl;
                }
            });

            async function submitData(url, data, formToHide) {
                 try {
                    // CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                    // hCaptcha (optional)
                    if (typeof hcaptcha !== 'undefined') {
                        try {
                            const token = await hcaptcha.execute('<%= hcaptchaSiteKey || '' %>', { action: 'submit' });
                            if (token) { data.hcaptchaToken = token; }
                        } catch (_) {}
                    }

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrfToken },
                        body: JSON.stringify(data),
                    });

                    if (response.ok) {
                        formToHide.classList.add('hidden');
                        if (userRating <= 4) {
                            thankYouSection.classList.remove('hidden');
                        }
                    } else {
                        alert('There was an error submitting your feedback.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An unexpected error occurred.');
                }
            }
        });
    </script>
    <%- include('partials/footer') %>
</body>
</html>

