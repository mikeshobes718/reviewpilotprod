<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Dashboard</title>
    <%- include('partials/head') %>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin:0; background: var(--bg); color: var(--text); }
        .main-content { padding: 2rem; }
        .container { max-width: 1100px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        @media (min-width: 900px) { .grid { grid-template-columns: 2fr 1fr; } }
        .column { display: grid; grid-auto-rows: min-content; gap: 16px; }
        .page-heading{ font-size:22px; font-weight:800; margin:0 0 12px; }

        .card{ background: var(--card); border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); padding:24px; }
        .card h2{ font-size: 20px; margin:0 0 12px; color: var(--text); border-bottom: 1px solid var(--border); padding-bottom: 10px; }

        .status{ display:inline-block; padding:4px 10px; border-radius:999px; color:#fff; font-weight:700; font-size:12px; letter-spacing:.03em; text-transform:uppercase }
        .status.active{ background: var(--accent); }
        .status.incomplete{ background:#E53E3E }

        form{ display:flex; flex-direction:column; gap:12px }
        label{ font-weight:600; color: var(--muted) }
        input[type="text"], input[type="url"]{ padding:12px 14px; border:1px solid var(--border); border-radius:8px; font-size:14px }
        input:focus{ outline:none; border-color: var(--accent); box-shadow:0 0 0 3px rgba(16,185,129,.2) }

        .btn{ display:inline-flex; align-items:center; gap:.5rem }
        .btn-primary{ background: var(--accent); color:#fff; border:none; border-radius:8px; padding:12px 14px; font-weight:700 }
        .btn-primary:hover{ background: var(--accentHover) }
        .btn-secondary{ background:transparent; border:1px solid var(--theme-colors-button-secondaryBorder); color: var(--theme-colors-button-secondaryText); border-radius:8px; padding:10px 12px; font-weight:600 }

        .link-box{ background: var(--bg); padding: 12px; border-radius:8px; font-family:monospace; border:1px solid var(--border) }

        .kpis{ display:grid; grid-template-columns: repeat(3,1fr); gap: 12px }
        .kpi{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; text-align:center }
        .kpi .label{ color: var(--muted); font-size:13px }
        .kpi .value{ font-size: 22px; font-weight:800; margin-top:4px }

        .sub-row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap }
        .qr-placeholder{ width:128px; height:128px; border:1px solid var(--border); border-radius:8px; display:block }

        /* Subscription widget layout */
        .plan-cols{ display:grid; grid-template-columns:1fr; gap:16px; align-items:stretch }
        @media (min-width: 700px){ .plan-cols{ grid-template-columns:1fr 1fr } }
        .plan-col{ padding:16px; display:flex; flex-direction:column; border-radius:12px }
        .plan-price{ display:flex; align-items:baseline; gap:6px; margin-top:4px }
        .plan-features{ list-style:none; padding:0; margin:12px 0 0; color:var(--muted); line-height:1.9 }
        .plan-actions{ margin-top:auto }
        /* Center the main subscription card */
        .subscription-wrap{ display:flex; justify-content:center; padding-top:48px }
        /* Notice banner */
        .notice-banner{ background:#EBF9F3; color:#065F46; padding:12px 16px; border-radius:8px; font-weight:600; display:flex; align-items:center; gap:8px }
        .btn-disabled{ background:#F3F4F6; color:#9CA3AF; cursor:not-allowed; border:none; border-radius:8px; padding:10px 12px; font-weight:700 }

        .table-wrap{ overflow:auto; border:1px solid var(--theme-colors-border-table); border-radius:12px }
        table{ width:100%; border-collapse:collapse }
        thead th{ position:sticky; top:0; z-index:1; background:#fff; font-size:12px; text-transform:uppercase; letter-spacing:.05em; color: var(--muted); border-bottom:1px solid var(--theme-colors-border-table); padding:16px }
        tbody tr{ border-bottom:1px solid var(--theme-colors-border-table) }
        tbody tr:hover{ background: var(--theme-colors-background-rowHover) }
        td{ padding:16px; vertical-align:top }
        .rating-star{ color:#FBBF24; font-weight:700 }

        /* Cancel modal */
        .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50 }
        .modal{ background: var(--card); border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); max-width:520px; width:92%; padding:24px }
        .modal h3{ margin:0 0 8px; font-size:18px }
        .modal p{ margin:0 0 16px; color: var(--muted) }
        .modal-actions{ display:flex; gap:8px; justify-content:flex-end }
        .btn-danger{ background:#FDECEC; color:#B91C1C; border:1px solid #F2B8B5; border-radius:8px; padding:10px 12px; font-weight:700 }
        .btn-ghost{ background:transparent; color: var(--muted); border:1px solid var(--border); border-radius:8px; padding:10px 12px; font-weight:600 }
    </style>
</head>
<body>
    <%- include('partials/header') %>

    <main class="main-content">
      <div class="container">
        <% if (typeof analytics !== 'undefined') { %>
        <h1 class="page-heading">Dashboard</h1>
        <div class="card base-card" style="margin-bottom:16px">
          <h2>Insights</h2>
          <div class="kpis">
            <div class="kpi"><div class="label">Total feedback</div><div class="value"><%= analytics.total %></div></div>
            <div class="kpi"><div class="label">Average rating</div><div class="value"><%= analytics.avg %></div></div>
            <div class="kpi"><div class="label">5★ conversions</div><div class="value"><%= analytics.conversions %></div></div>
          </div>
          <p style="margin-top:1rem; color: var(--text-secondary);">Distribution: 1★ <%= analytics.counts[1] %> • 2★ <%= analytics.counts[2] %> • 3★ <%= analytics.counts[3] %> • 4★ <%= analytics.counts[4] %> • 5★ <%= analytics.counts[5] %></p>
        </div>
        <% } %>
        <div class="grid">
          <div class="column">
            <div class="card base-card">
              <h2>Customer Feedback</h2>
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>Rating</th>
                      <th>Name</th>
                      <th>Contact</th>
                      <th>Details</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (feedback.length > 0) { %>
                      <% feedback.forEach(item => { %>
                        <tr>
                          <td><span class="rating-star"><%= item.rating %> ★</span></td>
                          <td><%= item.name %></td>
                          <td>
                            <%= item.email %>
                            <% if (item.phone) { %><br><%= item.phone %><% } %>
                          </td>
                          <td><%= item.feedback || '-' %></td>
                          <td><%= new Date(item.createdAt).toLocaleDateString() %></td>
                        </tr>
                      <% }); %>
                    <% } else { %>
                      <tr>
                        <td colspan="5" style="text-align:center; color: var(--muted); padding:28px 16px;">Your customer feedback will appear here.</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="column">
            <% if (business.subscriptionStatus === 'active') { %>
            <div class="card base-card">
              <h2>Settings & Rating Link</h2>
              <form action="/update-settings" method="POST">
                <input type="hidden" name="_csrf" value="<%= (typeof csrfToken !== 'undefined' ? csrfToken : '') %>">
                <label for="googlePlaceId">Your Google Place ID:</label>
                <input type="text" id="googlePlaceId" name="googlePlaceId" value="<%= business.googlePlaceId || '' %>" placeholder="Enter your Google Place ID here" required>
                <button type="submit" class="btn-primary">Save Settings</button>
              </form>
              <br>
              <label>Your Unique Rating Link:</label>
              <div class="link-box" id="publicLink"><%= appUrl %>/rate/<%= user.uid %></div>
              <div class="btns" style="display:flex; gap:.5rem; margin-top:.5rem;">
                <button class="btn btn-secondary" id="copyBtn" type="button">Copy link</button>
                <a class="btn btn-secondary" id="openLink" href="<%= appUrl %>/rate/<%= user.uid %>" target="_blank" rel="noopener">Open link</a>
              </div>
              <div style="margin-top:1rem;">
                <div style="font-weight:600; color: var(--text-secondary); margin-bottom:.25rem;">QR Code</div>
                <div id="qrcode" aria-label="QR code for your rating link"></div>
              </div>
            </div>
            <% } %>

            <div class="card base-card">
              <h2 style="margin:0 0 12px;border-bottom:1px solid var(--border);padding-bottom:10px">Subscription</h2>
              <% if (business.subscriptionStatus === 'active') { %>
                <div style="margin-bottom:10px;color:var(--muted)">Plan: <strong>Pro</strong></div>
                <% if (billing) { %>
                  <div style="color:var(--muted);margin-bottom:8px">
                    <% if (billing.card) { %>
                      Card on file: <strong><%= billing.card.brand %></strong> ending in <strong><%= billing.card.last4 %></strong> (exp <%= billing.card.exp %>)
                    <% } else { %>
                      No payment method on file yet.
                    <% } %>
                  </div>
                  <div style="margin-top:6px;color:var(--muted);font-size:13px">
                    <span>Renews: <strong><%= billing.currentPeriodEnd ? new Date(billing.currentPeriodEnd).toLocaleString() : '—' %></strong></span>
                    <% if (billing.cancelAtPeriodEnd) { %>
                      <span style="margin-left:10px;color:#B45309">(Cancels at period end)</span>
                    <% } %>
                  </div>
                <% } %>
                <a href="/billing-portal" class="btn btn-secondary" style="margin-top:12px">Manage Billing</a>
              <% } else { %>
                <% if (typeof pageError !== 'undefined' && pageError) { %>
                  <div class="notice-banner" style="background:#FEF2F2;color:#991B1B">Error: <%= pageError %></div>
                <% } %>
                <% if (typeof business !== 'undefined' && business.subscriptionStatus === 'trial' && business.trialEndsAt) { %>
                  <div class="notice-banner" style="margin-bottom:12px">
                    <span aria-hidden="true">✅</span>
                    <span>Free trial active — ends <strong><%= new Date(business.trialEndsAt).toLocaleDateString() %></strong></span>
                  </div>
                <% } %>
                <!-- Show upgrade CTA when not on Pro -->
                <div class="plan-cols">
                  <div class="plan-col" style="border:2px solid #10B981; border-radius:12px">
                    <div class="card-title" style="font-size:18px">Pro</div>
                    <div class="plan-price">
                      <div class="price-figure">$49</div>
                      <div class="price-label">/mo</div>
                    </div>
                    <ul class="plan-features">
                      <li><span class="check">✓</span>Unlimited requests</li>
                      <li><span class="check">✓</span>Full analytics & exports</li>
                      <li><span class="check">✓</span>Priority support</li>
                    </ul>
                    <div class="plan-actions">
                      <button id="btn-upgrade-pro" class="btn-primary">Upgrade to Pro</button>
                    </div>
                  </div>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </main>
    <div class="toast" id="toast">Link copied</div>
    <div class="modal-overlay" id="cancelModal">
      <div class="modal">
        <h3>Cancel Pro subscription?</h3>
        <p>Are you sure you want to cancel your Pro subscription? Your plan will remain active until the end of your current billing period.</p>
        <div class="modal-actions">
          <button class="btn-ghost" id="cancelClose">Keep Pro</button>
          <button class="btn-danger" id="cancelConfirm">Cancel Pro</button>
        </div>
      </div>
    </div>
    <%- include('partials/footer') %>
    <script>
      (function(){
        const btn = document.getElementById('copyBtn');
        if (!btn) return;
        const toast = document.getElementById('toast');
        async function copyText(str){
          // Try modern async clipboard API first
          try {
            if (navigator.clipboard && window.isSecureContext) {
              await navigator.clipboard.writeText(str);
              return true;
            }
          } catch(_){}
          // Fallback for Safari/iOS and older browsers
          try {
            const ta = document.createElement('textarea');
            ta.value = str; ta.setAttribute('readonly','');
            ta.style.position='absolute'; ta.style.left='-9999px';
            document.body.appendChild(ta);
            ta.select(); ta.setSelectionRange(0, str.length);
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
          } catch(_) { return false; }
        }
        btn.addEventListener('click', async () => {
          const link = document.getElementById('publicLink').innerText.trim();
          const ok = await copyText(link);
          if (ok) {
            toast.classList.add('show');
            setTimeout(()=>toast.classList.remove('show'), 1600);
          } else {
            alert('Copy failed');
          }
        });
      })();
    </script>
    <!-- Lightweight QR code generator; allowed in dev where CSP is disabled -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
      (function(){
        var box = document.getElementById('qrcode');
        if (!box) return;
        var link = document.getElementById('publicLink').innerText.trim();
        // Clear any existing QR to avoid duplicates
        while (box.firstChild) box.removeChild(box.firstChild);
        try { new QRCode(box, { text: link, width: 160, height: 160, correctLevel: QRCode.CorrectLevel.M }); } catch(e) { console.error('QR error', e); }
      })();
    </script>
    <script>
      (function(){
        var upgradeBtn = document.getElementById('btn-upgrade-pro');
        var downgradeBtn = document.getElementById('btn-downgrade');
        var modal = document.getElementById('cancelModal');
        var modalClose = document.getElementById('cancelClose');
        var modalConfirm = document.getElementById('cancelConfirm');
        if (downgradeBtn && modal) {
          downgradeBtn.addEventListener('click', function(){ modal.style.display = 'flex'; });
          modalClose && modalClose.addEventListener('click', function(){ modal.style.display = 'none'; });
          modal.addEventListener('click', function(e){ if (e.target === modal) modal.style.display = 'none'; });
          if (modalConfirm) {
            modalConfirm.addEventListener('click', async function(){
              modalConfirm.disabled = true; modalConfirm.textContent = 'Cancelling…';
              try {
                const resp = await fetch('/subscription/cancel', { method: 'POST', headers: { 'X-Requested-With':'XMLHttpRequest', 'Content-Type':'application/x-www-form-urlencoded' }, body: '_csrf=<%= (typeof csrfToken !== 'undefined' ? csrfToken : '') %>' });
                if (resp.ok) { window.location.reload(); return; }
              } catch(_) {}
              modalConfirm.disabled = false; modalConfirm.textContent = 'Cancel Pro';
              alert('Could not cancel subscription. Try again.');
            });
          }
        }
        if (!upgradeBtn) return;
        var publishableKey = '<%= process.env.STRIPE_PUBLISHABLE_KEY || "" %>';
        var stripe = (window.Stripe && publishableKey) ? Stripe(publishableKey) : null;
        upgradeBtn.addEventListener('click', async function(){
          upgradeBtn.disabled = true; upgradeBtn.textContent = 'Redirecting...';
          try {
            const resp = await fetch('/create-checkout-session', {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded' },
              body: '_csrf=<%= (typeof csrfToken !== 'undefined' ? csrfToken : '') %>',
              credentials: 'same-origin'
            });
            if (!resp.ok) { window.location.href = '/dashboard?e=' + encodeURIComponent('Checkout request failed'); return; }
            const data = await resp.json().catch(()=>null);
            if (data && data.id && stripe) {
              const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
              if (!error) return;
            }
            if (data && data.url) { window.location = data.url; return; }
            if (resp.redirected && resp.url) { window.location = resp.url; return; }
            window.location.href = '/dashboard?e=' + encodeURIComponent('Checkout session not available');
          } catch (e) {
            console.error('stripe checkout error', e);
            window.location.href = '/dashboard?e=' + encodeURIComponent('Checkout failed');
          }
        });
      })();
    </script>
</body>
</html>

